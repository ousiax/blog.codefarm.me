<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bing WebMaster -->
  <meta name="msvalidate.01" content="AB2FFF876C37F59D9121882CC8395DE5" />

  <title>RUNC CONTAINERD CRI DOCKERSHIM</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://blog.codefarm.me/2021/11/25/oci-runc-containerd-cri-dockershim/">
  <link rel="alternate" type="application/rss+xml" title="CODE FARM" href="https://blog.codefarm.me/feed.xml">

  <!--<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" />-->

  <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->
<script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>

  
<!-- Google Analytics Website tracking -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83971182-1', 'auto');
  ga('send', 'pageview');

</script>


  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SN88FJ18E5');
</script>



</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <h2 class="site-title">
      <a class="site-title" href="/">CODE FARM</a>
    </h2>

     <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
        <div class="trigger">
            <ul>
                <li><a href="/">home</a>
                <li><a href="/category">category</a>
                <li><a href="/tag">tag</a>
                <li><a href="/archive">archive</a>
                <li><a href="/about">about</a>
                <li><a href="https://resume.github.io/?ousiax" target="_blank">R&eacute;sum&eacute;</a>
            </ul>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">RUNC CONTAINERD CRI DOCKERSHIM</h1>
    
    
    <p class="post-meta"><time datetime="2021-11-25T11:03:28+08:00" itemprop="datePublished">Feb 3, 2024</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#open-container-initiative">1. Open Container Initiative</a></li>
<li><a href="#runc">2. runC</a></li>
<li><a href="#containerd">3. containerd</a>
<ul class="sectlevel2">
<li><a href="#containerdconfig">3.1. containerd/config</a></li>
<li><a href="#containerdplugins">3.2. containerd/plugins</a></li>
<li><a href="#containerdcri">3.3. containerd/cri</a></li>
<li><a href="#containerdnamespaces">3.4. containerd/namespaces</a></li>
<li><a href="#contianerdproxy">3.5. contianerd/proxy</a></li>
</ul>
</li>
<li><a href="#crictl">4. crictl</a></li>
<li><a href="#docker-and-dockershim">5. docker and dockershim</a></li>
<li><a href="#sandbox-image-and-pause-container">6. Sandbox image and pause container</a></li>
<li><a href="#references">7. References</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="open-container-initiative">1. Open Container Initiative</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://opencontainers.org/">Open Container Initiative</a> (OCI) is an open governance structure for the express purpose of creating open industry standards around <em>container formats and runtimes</em>.</p>
</div>
<div class="paragraph">
<p>Docker is donating its container format and runtime, <a href="https://github.com/opencontainers/runc">runC</a>, to the OCI to serve as the cornerstone of this new effort.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="runc">2. runC</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>unix principles: several simple components are better than a single, complicated one</em>.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/opencontainers/runc"><code>runc</code></a>  is a CLI tool, only supports Linux, for spawning and running containers on Linux according to the OCI specification.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/Microsoft/hcsshim/tree/master/cmd/runhcs"><code>runhcs</code></a> is a fork of runc, a command line client for running applications packaged on Windows according to the OCI format and is a compliant implementation of the OCI specification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>runc
<span class="go">NAME:
   runc - Open Container Initiative runtime

runc is a command line client for running applications packaged according to
the Open Container Initiative (OCI) format and is a compliant implementation of the
Open Container Initiative specification.

runc integrates well with existing process supervisors to provide a production
container runtime environment for applications. It can be used with your
existing process monitoring tools and the container will be spawned as a
direct child of the process supervisor.

Containers are configured using bundles. A bundle for a container is a directory
that includes a specification file named "config.json" and a root filesystem.
The root filesystem contains the contents of the container.

GLOBAL OPTIONS:
   --root value  root directory for storage of container state (this should be located in tmpfs) (default: "/run/user/1000/runc")</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Lists containers started by runc with containerd using Docker with the given root (default "/var/run/docker/runtime-runc/moby")</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>dockerd <span class="nt">--help</span> | <span class="nb">grep </span>exec-root
<span class="hll"><span class="go">      --exec-root string                        Root directory for execution state files (default "/var/run/docker")</span>
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>runc <span class="nt">--root</span> /var/run/docker/runtime-runc/moby list
<span class="go">ID                                                                 PID         STATUS      BUNDLE                                                                                                                CREATED                          OWNER</span>
<span class="go">011d6fd316e09fc8a5ff3b226d35b9394cd93c57604c91aa52573559368a822c   940971      running     /run/containerd/io.containerd.runtime.v2.task/moby/011d6fd316e09fc8a5ff3b226d35b9394cd93c57604c91aa52573559368a822c   2021-11-25T04:10:25.216394136Z   root</span>
<span class="go">. . .</span></code></pre>
</div>
</div>
</li>
<li>
<p>Lists containers started by runc with containerd using Kubernetes with the given root (default "/run/containerd/runc/k8s.io")</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>containerd config dump | <span class="nb">grep</span> <span class="s1">'^state'</span>
<span class="go">state = "/run/containerd"
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>runc <span class="nt">--root</span> /run/containerd/runc/k8s.io list
<span class="go">ID                                                                 PID         STATUS      BUNDLE                                                                                                                  CREATED                          OWNER
14542e5b60446f87af20e200e019a15d1ad1509eb506a2068266b9f98694c704   1191        running     /run/containerd/io.containerd.runtime.v2.task/k8s.io/14542e5b60446f87af20e200e019a15d1ad1509eb506a2068266b9f98694c704   2021-12-08T12:55:21.616268255Z   root
. . .
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>runc <span class="nt">--root</span> /run/containerd/runc/k8s.io state 14542e5b60446f87af20e200e019a15d1ad1509eb506a2068266b9f98694c704
<span class="go">{
  "ociVersion": "1.0.2-dev",
  "id": "14542e5b60446f87af20e200e019a15d1ad1509eb506a2068266b9f98694c704",
  "pid": 1191,
  "status": "running",
  "bundle": "/run/containerd/io.containerd.runtime.v2.task/k8s.io/14542e5b60446f87af20e200e019a15d1ad1509eb506a2068266b9f98694c704",
  "rootfs": "/run/containerd/io.containerd.runtime.v2.task/k8s.io/14542e5b60446f87af20e200e019a15d1ad1509eb506a2068266b9f98694c704/rootfs",
  "created": "2021-12-08T12:55:21.616268255Z",
  "annotations": {
    "io.kubernetes.cri.container-name": "kube-flannel",
    "io.kubernetes.cri.container-type": "container",
    "io.kubernetes.cri.image-name": "quay.io/coreos/flannel:v0.15.0",
    "io.kubernetes.cri.sandbox-id": "f0c7bf11fac17f29a8df40f1d937ec35df81e202e42ea8a604e37806aebbb662",
    "io.kubernetes.cri.sandbox-name": "kube-flannel-ds-6xpbj",
    "io.kubernetes.cri.sandbox-namespace": "kube-system"
  },
  "owner": ""
}
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>runc <span class="nt">--root</span> /run/containerd/runc/k8s.io ps 14542e5b60446f87af20e200e019a15d1ad1509eb506a2068266b9f98694c704
<span class="go">UID         PID   PPID  C STIME TTY          TIME CMD
root       1191    806  0 Dec08 ?        00:00:25 /opt/bin/flanneld --ip-masq --kube-subnet-mgr</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="containerd">3. containerd</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://containerd.io/">containerd</a> is available as a daemon for Linux and Windows. It manages the complete container lifecycle of its host system, from image transfer and storage to container execution and supervision to low-level storage to network attachments and beyond.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/container/contianerd/architecture.png" alt="architecture" width="45%" height="45%"></span>
<span class="image"><img src="https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/media/containerd-platform.png" alt="containerd platform" width="45%" height="45%"></span></p>
</div>
<div class="paragraph">
<p>containerd is designed to be embedded into a larger system, rather than being used directly by developers or end-users.</p>
</div>
<div class="paragraph">
<p>There are many different ways to use containerd:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you are a developer working on containerd you can use the <code>ctr</code> tool to quickly test features and functionality without writing extra code</p>
</li>
<li>
<p>If you want to integrate containerd into your project, you can use a simple client package.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>ctr
<span class="go">containerd CLI

USAGE:
   ctr [global options] command [command options] [arguments...]

VERSION:
   1.6.27

DESCRIPTION:

ctr is an unsupported debug and administrative client for interacting
with the containerd daemon. Because it is unsupported, the commands,
options, and operations are not guaranteed to be backward compatible or
stable from release to release of the containerd project.

COMMANDS:
   plugins, plugin            provides information about containerd plugins
   version                    print the client and server versions
   containers, c, container   manage containers
   content                    manage content
   events, event              display containerd events
   images, image, i           manage images
   leases                     manage leases
   namespaces, namespace, ns  manage namespaces
   pprof                      provide golang pprof outputs for containerd
   run                        run a container
   snapshots, snapshot        manage snapshots
   tasks, t, task             manage tasks
   install                    install a new package
   oci                        OCI tools
   deprecations
   shim                       interact with a shim directly
   help, h                    Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --debug                      enable debug output in logs
</span><span class="gp">   --address value, -a value    address for containerd's GRPC server (default: "/run/containerd/containerd.sock") [$</span>CONTAINERD_ADDRESS]
<span class="go">   --timeout value              total timeout for ctr commands (default: 0s)
   --connect-timeout value      timeout for connecting to containerd (default: 0s)
</span><span class="gp">   --namespace value, -n value  namespace to use with commands (default: "default") [$</span>CONTAINERD_NAMESPACE]
<span class="go">   --help, -h                   show help
   --version, -v                print the version</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Save image from Docker and import to containerd</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh">docker save nginx:1.25 | xz <span class="nt">-zv</span> <span class="nt">-T0</span> <span class="o">&gt;</span> nginx.1.25.tar.xz
<span class="c"># same as ctr -n moby i export</span>
<span class="nb">sudo </span>ctr <span class="nt">-n</span> moby i <span class="nb">export</span> /dev/stdout docker.io/library/nginx:1.25 | xz <span class="nt">-zv</span> <span class="nt">-T0</span> <span class="o">&gt;</span> nginx.1.25.tar.xz</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>docker save nginx:1.25 | xz <span class="nt">-zv</span> <span class="nt">-T0</span> <span class="o">&gt;</span> nginx.1.25.tar.xz
<span class="go">  100 %        41.9 MiB / 182.0 MiB = 0.230   8.0 MiB/s       0:22
</span><span class="gp">$</span><span class="w"> </span>xz <span class="nt">-dk</span> nginx.1.25.tar.xz
<span class="gp">$</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">nginx.1.25.tar  nginx.1.25.tar.xz
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr i import nginx.1.25.tar <span class="c"># import to the default namespace</span>
<span class="go">unpacking docker.io/library/nginx:1.25 (sha256:7477fb7aa691ad976bdd0f12afd00c094e8bef473051e5125591f532efd21022)...done
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr ns <span class="nb">ls</span>
<span class="go">NAME    LABELS
default
k8s.io
moby
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr i <span class="nb">ls</span> <span class="c"># same as `sudo ctr -n default i ls`</span>
<span class="go">REF                          TYPE                                                 DIGEST                                                                  SIZE      PLATFORMS   LABELS
docker.io/library/nginx:1.25 application/vnd.docker.distribution.manifest.v2+json sha256:7477fb7aa691ad976bdd0f12afd00c094e8bef473051e5125591f532efd21022 182.0 MiB linux/amd64 -</span></code></pre>
</div>
</div>
</li>
<li>
<p>Show the information about containerd plugins</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr plugin <span class="nb">ls</span>
<span class="go">TYPE                                  ID                       PLATFORMS      STATUS
io.containerd.content.v1              content                  -              ok
. . .
io.containerd.snapshotter.v1          overlayfs                linux/amd64    ok
io.containerd.snapshotter.v1          zfs                      linux/amd64    skip
io.containerd.metadata.v1             bolt                     -              ok
. . .
io.containerd.grpc.v1                 cri                      linux/amd64    ok

</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr plugin <span class="nb">ls</span> <span class="nt">-d</span> <span class="nb">id</span><span class="o">==</span>cri
<span class="go">Type:          io.containerd.grpc.v1
ID:            cri
Requires:
               io.containerd.event.v1
               io.containerd.service.v1
               io.containerd.warning.v1
Platforms:     linux/amd64
Exports:
               CRIVersionAlpha      v1alpha2
               CRIVersion           v1</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="containerdconfig">3.1. containerd/config</h3>
<div class="paragraph">
<p>containerd is meant to be a simple daemon to run on any system. It provides a minimal <a href="https://github.com/containerd/containerd/blob/main/docs/ops.md">config</a> with knobs to configure the daemon and what <a href="https://github.com/containerd/containerd/blob/main/docs/PLUGINS.md"><em>plugins</em></a> are used when necessary.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>containerd <span class="nb">help</span>
<span class="go">high performance container runtime


USAGE:
   containerd [global options] command [command options] [arguments...]

VERSION:
   1.6.27

DESCRIPTION:

containerd is a high performance container runtime whose daemon can be started
by using this command. If none of the *config*, *publish*, or *help* commands
are specified, the default action of the **containerd** command is to start the
containerd daemon in the foreground.


A default configuration is used if no TOML configuration is specified or located
at the default file location. The *containerd config* command can be used to
generate the default configuration for containerd. The output of that command
can be used and modified as necessary as a custom configuration.

COMMANDS:
   config    information on the containerd config
   publish   binary to publish events to containerd
   oci-hook  provides a base for OCI runtime hooks to allow arguments to be injected.
   help, h   Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --config value, -c value     path to the configuration file (default: "/etc/containerd/config.toml")
   --log-level value, -l value  set the logging level [trace, debug, info, warn, error, fatal, panic]
   --address value, -a value    address for containerd's GRPC server
   --root value                 containerd root directory
   --state value                containerd state directory
   --help, -h                   show help
   --version, -v                print the version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While a few daemon level options can be set from CLI flags, the majority of containerd&#8217;s configuration is kept in the configuration file. In the containerd config file you will find settings for persistent and runtime storage locations as well as grpc, debug, and metrics addresses for the various APIs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>containerd config dump <span class="c"># See the output of the final main config</span>
<span class="go">. . .
root = "/var/lib/containerd"
state = "/run/containerd"
. . .</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>root</code> will be used to store any type of persistent data for containerd. Snapshots, content, metadata for containers and image, as well as any plugin data will be kept in this location.</p>
<div class="paragraph">
<p>The root is also <em>namespaced</em> for plugins that containerd loads. Each plugin will have its own directory where it stores data. containerd itself does not actually have any persistent data that it needs to store, its functionality comes from the plugins that are loaded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">/var/lib/containerd/
├── io.containerd.content.v1.content
│   └── ingest
├── io.containerd.metadata.v1.bolt
│   └── meta.db
├── io.containerd.runtime.v1.linux
├── io.containerd.runtime.v2.task
├── io.containerd.snapshotter.v1.btrfs
├── io.containerd.snapshotter.v1.native
│   └── snapshots
├── io.containerd.snapshotter.v1.overlayfs
│   └── snapshots
└── tmpmounts</span></code></pre>
</div>
</div>
</li>
<li>
<p><code>state</code> will be used to store any type of ephemeral data. Sockets, pids, runtime state, mount points, and other plugin data that must not persist between reboots are stored in this location.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">run/containerd/
├── containerd.sock
├── containerd.sock.ttrpc
├── io.containerd.runtime.v1.linux
└── io.containerd.runtime.v2.task</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both the <code>root</code> and <code>state</code> directories are namespaced for plugins.</p>
</div>
<div class="paragraph">
<p>By the way, you can also type the command: <code>containerd config default</code> to print the output of the default config. The follow sample is used by Docker CE as default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="toml"><span class="hll"><span class="py">disabled_plugins</span> <span class="p">=</span> <span class="p">[</span><span class="s">"cri"</span><span class="p">]</span>
</span>
<span class="c">#root = "/var/lib/containerd"</span>
<span class="c">#state = "/run/containerd"</span>
<span class="c">#subreaper = true</span>
<span class="c">#oom_score = 0</span>

<span class="c">#[grpc]</span>
<span class="c">#  address = "/run/containerd/containerd.sock"</span>
<span class="c">#  uid = 0</span>
<span class="c">#  gid = 0</span>

<span class="c">#[debug]</span>
<span class="c">#  address = "/run/containerd/debug.sock"</span>
<span class="c">#  uid = 0</span>
<span class="c">#  gid = 0</span>
<span class="c">#  level = "info"</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You need CRI support enabled to use containerd with Kubernetes. Make sure that cri is not included in the <code>disabled_plugins</code> list.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="containerdplugins">3.2. containerd/plugins</h3>
<div class="paragraph">
<p>At the end of the day, containerd&#8217;s core is very small. The real functionality comes from <a href="https://github.com/containerd/containerd/blob/main/docs/PLUGINS.md">plugins</a>. Everything from snapshotters, runtimes, and content are all plugins that are registered at runtime. Because these various plugins are so different we need a way to provide type safe configuration to the plugins. The only way we can do this is via the config file and not CLI flags.</p>
</div>
<div class="sect3">
<h4 id="built-in-plugins">3.2.1. Built-in Plugins</h4>
<div class="paragraph">
<p>containerd uses plugins internally to ensure that internal implementations are decoupled, stable, and treated equally with external plugins. To see all the plugins containerd has, use <code>ctr plugins ls</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr plugin <span class="nb">ls</span>
<span class="go">TYPE                            ID                       PLATFORMS      STATUS
io.containerd.content.v1        content                  -              ok
io.containerd.snapshotter.v1    aufs                     linux/amd64    error
io.containerd.snapshotter.v1    btrfs                    linux/amd64    error
io.containerd.snapshotter.v1    devmapper                linux/amd64    error
io.containerd.snapshotter.v1    native                   linux/amd64    ok
io.containerd.snapshotter.v1    overlayfs                linux/amd64    ok
io.containerd.snapshotter.v1    zfs                      linux/amd64    error
io.containerd.metadata.v1       bolt                     -              ok
io.containerd.differ.v1         walking                  linux/amd64    ok
io.containerd.gc.v1             scheduler                -              ok
</span><span class="c">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From the output all the plugins can be seen as well those which did not successfully load. In this case <code>aufs</code> and <code>zfs</code> are expected not to load since they are not support on the machine. The logs will show why it failed, but you can also get more details using the <code>-d</code> option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr plugin <span class="nb">ls</span> <span class="nt">-d</span> <span class="nb">id</span><span class="o">==</span>aufs <span class="nb">id</span><span class="o">==</span>zfs
<span class="go">Type:          io.containerd.snapshotter.v1
ID:            aufs
Platforms:     linux/amd64
Exports:
               root      /var/lib/containerd/io.containerd.snapshotter.v1.aufs
Error:
               Code:        Unknown
               Message:     aufs is not supported (modprobe aufs failed: exit status 1 "modprobe: FATAL: Module aufs not found in directory /lib/modules/5.10.0-9-amd64\n"): skip plugin

Type:          io.containerd.snapshotter.v1
ID:            zfs
Platforms:     linux/amd64
Exports:
               root      /var/lib/containerd/io.containerd.snapshotter.v1.zfs
Error:
               Code:        Unknown
               Message:     path /var/lib/containerd/io.containerd.snapshotter.v1.zfs must be a zfs filesystem to be used with the zfs snapshotter: skip plugin</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration">3.2.2. Configuration</h4>
<div class="paragraph">
<p>Plugins are configured using the <code>[plugins]</code> section of containerd&#8217;s config. Every plugin can have its own section using the pattern <code>[plugins.&lt;plugin id&gt;]</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="toml"><span class="nn">[plugins]</span>
  <span class="c"># indentation (tabs and/or spaces) is allowed but not required</span>
<span class="hll">  <span class="nn">[plugins."io.containerd.grpc.v1.cri"]</span>
</span>    <span class="py">sandbox_image</span> <span class="p">=</span> <span class="s">"k8s.gcr.io/pause:3.5"</span>
    <span class="c"># &lt;other paramters&gt;</span>
<span class="hll">    <span class="nn">[plugins."io.containerd.grpc.v1.cri".cni]</span>
</span>      <span class="py">bin_dir</span> <span class="p">=</span> <span class="s">"/opt/cni/bin"</span>
      <span class="py">conf_dir</span> <span class="p">=</span> <span class="s">"/etc/cni/net.d"</span>
      <span class="c"># &lt;other paramters&gt;</span>
    <span class="nn">[plugins."io.containerd.grpc.v1.cri".containerd]</span>
        <span class="c"># &lt;other paramters&gt;</span>
        <span class="nn">[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]</span>
          <span class="c"># &lt;other paramters&gt;</span>
<span class="hll">          <span class="nn">[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]</span>
</span>            <span class="c"># &lt;other paramters&gt;</span>
            <span class="py">SystemdCgroup</span> <span class="p">=</span> <span class="kc">true</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="containerdcri">3.3. containerd/cri</h3>
<div class="paragraph">
<p><a href="https://github.com/containerd/containerd/tree/main/pkg/cri">cri</a> is a containerd built-in plugin implementation of Kubernetes <a href="https://github.com/kubernetes/cri-api">Container Runtime Interface (CRI)</a>.</p>
</div>
<div class="paragraph">
<p>While OCI specs defines a single <em>container</em>, CRI (Container Runtime Interface) describes containers as workload(s) in a shared sandbox environment called a <em>pod</em>. Pods can contain one or more container workloads.</p>
</div>
<div class="paragraph">
<p>With it, you could run Kubernetes using containerd as the container runtime.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/kubernetes/containerd/cri.png" alt="cri" width="55%" height="55%">
</div>
</div>
<div class="paragraph">
<p><code>crictl</code> is a command-line interface for CRI-compatible container runtimes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl pods
<span class="go">POD ID              CREATED             STATE               NAME                             NAMESPACE           ATTEMPT             RUNTIME
f69d876947d10       About an hour ago   Ready               coredns-5dd5756b68-6zhnn         kube-system         0                   (default)
05b17a7b61b01       About an hour ago   Ready               kube-apiserver-node-1            kube-system         0                   (default)
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl inspectp f69d876947d10 | <span class="nb">head</span>
<span class="go">{
  "status": {
    "id": "f69d876947d103f23b41ca677e498468aaef6a9d35e287c6dcd999cf62e40dbd",
    "metadata": {
      "attempt": 0,
      "name": "coredns-5dd5756b68-6zhnn",
      "namespace": "kube-system",
      "uid": "f364d6dd-ba20-4ab6-8ebb-0053ac1b43e0"
    },
    "state": "SANDBOX_READY",</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="containerdnamespaces">3.4. containerd/namespaces</h3>
<div class="paragraph">
<p>containerd offers a fully <a href="https://github.com/containerd/containerd/blob/main/docs/namespaces.md">namespaced API</a> so multiple consumers can all use a single containerd instance without conflicting with one another, that allows <em>multi-tenancy</em> within a single daemon.</p>
</div>
<div class="paragraph">
<p>Consumers are able to have containers with the same names but with settings and/or configurations that vary drastically. For example, system or infrastructure level containers can be hidden in one namespace while user level containers are kept in another. <em>Underlying image content is still shared via content addresses but image names and metadata are separate per namespace.</em></p>
</div>
<div class="paragraph">
<p>Namespaces allow various features, most notably, the ability for one client to create, edit, and delete resources without affecting another client. A resource can be anything from an: image, container, task, or snapshot.</p>
</div>
<div class="paragraph">
<p>When a client queries for a resource, they only see the resources that are part of their namespace.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>list namespaces</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr ns <span class="nb">ls</span> <span class="c"># list namespaces</span>
<span class="go">NAME    LABELS
default
k8s.io
moby</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>moby</code> is default namespace for <a href="https://docs.docker.com/engine/reference/commandline/dockerd/">dockerd</a> and <code>k8s.io</code> is default namespace for <a href="https://kubernetes.io/docs/concepts/overview/components/#kubelet">kubelet</a>, i.e. Kubernetes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>dockerd <span class="nt">--help</span> | <span class="nb">grep </span>containerd-namespace
<span class="go">      --containerd-namespace string             Containerd namespace to use (default "moby")
</span><span class="gp">$</span><span class="w"> </span>kubelet <span class="nt">--help</span> | <span class="nb">grep </span>containerd-namespace
<span class="go">      --containerd-namespace string                              containerd namespace (default "k8s.io") (DEPRECATED: This is a cadvisor flag that was mistakenly registered with the Kubelet. Due to legacy concerns, it will follow the standard CLI deprecation timeline before being removed.)</span></code></pre>
</div>
</div>
</li>
<li>
<p>pull image to namespace <code>alice</code> (create it if not existed)</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice image pull docker.io/library/nginx:1.25
<span class="go">docker.io/library/nginx:1.25:                                                     resolved       |++++++++++++++++++++++++++++++++++++++|
index-sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c:    done           |++++++++++++++++++++++++++++++++++++++|
manifest-sha256:48a84a0728cab8ac558f48796f901f6d31d287101bc8b317683678125e0d2d35: done           |++++++++++++++++++++++++++++++++++++++|
layer-sha256:da761d9a302b21dc50767b67d46f737f5072fb4490c525b4a7ae6f18e1dbbf75:    done           |++++++++++++++++++++++++++++++++++++++|
config-sha256:eea7b3dcba7ee47c0d16a60cc85d2b977d166be3960541991f3e6294d795ed24:   done           |++++++++++++++++++++++++++++++++++++++|
. . .
elapsed: 65.9s                                                                    total:  66.8 M (1.0 MiB/s)
unpacking linux/amd64 sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c...
done: 2.224968944s</span></code></pre>
</div>
</div>
</li>
<li>
<p>pull image to namespace <code>bob</code> (create it if not existed)</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> bob image pull docker.io/library/nginx:1.25
<span class="go">docker.io/library/nginx:1.25:                                                     resolved       |++++++++++++++++++++++++++++++++++++++|
index-sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c:    done           |++++++++++++++++++++++++++++++++++++++|
manifest-sha256:48a84a0728cab8ac558f48796f901f6d31d287101bc8b317683678125e0d2d35: done           |++++++++++++++++++++++++++++++++++++++|
layer-sha256:da761d9a302b21dc50767b67d46f737f5072fb4490c525b4a7ae6f18e1dbbf75:    done           |++++++++++++++++++++++++++++++++++++++|
config-sha256:eea7b3dcba7ee47c0d16a60cc85d2b977d166be3960541991f3e6294d795ed24:   done           |++++++++++++++++++++++++++++++++++++++|
. . .
elapsed: 2.2 s                                                                    total:   0.0 B (0.0 B/s)
unpacking linux/amd64 sha256:104c7c5c54f2685f0f46f3be607ce60da7085da3eaa5ad22d3d9f01594295e9c...
done: 2.453252148s</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The elapsed time of the same image pulled in the <code>bob</code> namespace is only 2.2 s.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>run a container in namespace <code>alice</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice run <span class="nt">--null-io</span> <span class="nt">-d</span> docker.io/library/nginx:1.25 nginx <span class="c"># run a container named `nginx`</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice c <span class="nb">ls</span> <span class="c"># list containers</span>
<span class="go">CONTAINER    IMAGE                           RUNTIME
nginx      docker.io/library/nginx:1.25    io.containerd.runc.v2
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">ls</span> <span class="c"># list tasks</span>
<span class="go">TASK       PID      STATUS
nginx    43776    RUNNING</span></code></pre>
</div>
</div>
</li>
<li>
<p>run a container in namespace <code>bob</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> bob run <span class="nt">--null-io</span> <span class="nt">-d</span> docker.io/library/nginx:1.25 nginx
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> bob c <span class="nb">ls</span>
<span class="go">CONTAINER    IMAGE                           RUNTIME
nginx        docker.io/library/nginx:1.25    io.containerd.runc.v2
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> bob t <span class="nb">ls</span>
<span class="go">TASK     PID       STATUS
nginx    647098    RUNNING</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The container name (i.e. <code>nginx</code>) in <code>bob</code> is same as in <code>alice</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>using the <code>nsenter</code> to test the nginx endpoint in the container</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">ls</span>
<span class="go">TASK       PID      STATUS
nginx-a    43776    RUNNING
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 43776 <span class="nt">-a</span> lsns
<span class="go">        NS TYPE   NPROCS PID USER COMMAND
</span><span class="gp">4026531835 cgroup      3   1 root nginx: master process nginx -g daemon off;</span><span class="w">
</span><span class="gp">4026531837 user        3   1 root nginx: master process nginx -g daemon off;</span><span class="w">
</span><span class="gp">4026532706 mnt         3   1 root nginx: master process nginx -g daemon off;</span><span class="w">
</span><span class="gp">4026532707 uts         3   1 root nginx: master process nginx -g daemon off;</span><span class="w">
</span><span class="gp">4026532708 ipc         3   1 root nginx: master process nginx -g daemon off;</span><span class="w">
</span><span class="gp">4026532709 pid         3   1 root nginx: master process nginx -g daemon off;</span><span class="w">
</span><span class="gp">4026532711 net         3   1 root nginx: master process nginx -g daemon off;</span><span class="w">
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 43776 <span class="nt">-n</span> curl <span class="nt">-iI</span> localhost
<span class="go">HTTP/1.1 200 OK
Server: nginx/1.25.2
Date: Tue, 22 Aug 2023 09:44:58 GMT
Content-Type: text/html
Content-Length: 615
Last-Modified: Tue, 15 Aug 2023 17:03:04 GMT
Connection: keep-alive
ETag: "64dbafc8-267"
Accept-Ranges: bytes</span></code></pre>
</div>
</div>
</li>
<li>
<p>stop a container</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice c <span class="nb">ls</span>
<span class="go">CONTAINER    IMAGE                           RUNTIME
nginx        docker.io/library/nginx:1.25    io.containerd.runc.v2
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">ls</span>
<span class="go">TASK     PID       STATUS
nginx    653417    RUNNING

// stop a container
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">kill</span> <span class="nt">-a</span> nginx
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">ls</span>
<span class="go">TASK     PID       STATUS
nginx    653417    STOPPED

// remove a stopped task
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">rm </span>nginx
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">ls</span>
<span class="go">TASK    PID    STATUS
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice c <span class="nb">ls</span>
<span class="go">CONTAINER    IMAGE                           RUNTIME
nginx        docker.io/library/nginx:1.25    io.containerd.runc.v2

// restart a container
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t start <span class="nt">--null-io</span> <span class="nt">-d</span> nginx
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">ls</span>
<span class="go">TASK     PID       STATUS
nginx    655518    RUNNING

// stop and remove a container
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">kill</span> <span class="nt">-a</span> nginx
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice t <span class="nb">rm </span>nginx
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice c <span class="nb">rm </span>nginx
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice c <span class="nb">ls</span>
<span class="go">CONTAINER    IMAGE    RUNTIME

// stop all containers in k8s.io namespace
// 9) SIGKILL	 15) SIGTERM
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> k8s.io tasks list <span class="nt">-q</span> | xargs <span class="nt">-r</span> <span class="nt">-I</span> <span class="o">{}</span> <span class="nb">sudo </span>ctr <span class="nt">-n</span> k8s.io tasks <span class="nb">kill</span> <span class="nt">-s</span> 9 <span class="nt">-a</span> <span class="o">{}</span>
<span class="go">// or
</span><span class="gp">$</span><span class="w"> </span><span class="k">for </span>task <span class="k">in</span> <span class="si">$(</span><span class="nb">sudo </span>ctr <span class="nt">-n</span> k8s.io tasks list <span class="nt">-q</span><span class="si">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> k8s.io tasks <span class="nb">kill</span> <span class="nt">-a</span> <span class="s2">"</span><span class="nv">$task</span><span class="s2">"</span><span class="p">;</span> <span class="k">done</span>
<span class="go">// or
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl stop <span class="si">$(</span><span class="nb">sudo </span>crictl ps <span class="nt">-q</span><span class="si">)</span></code></pre>
</div>
</div>
</li>
<li>
<p>clean a namespace</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr ns <span class="nb">rm </span>alice
<span class="go">ERRO[0000] unable to delete alice                        error="namespace \"alice\" must be empty, but it still has images, blobs, containers, snapshots on \"overlayfs\" snapshotter: failed precondition"
ctr: unable to delete alice: namespace "alice" must be empty, but it still has images, blobs, containers, snapshots on "overlayfs" snapshotter: failed precondition

</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> alice i <span class="nb">rm </span>docker.io/library/nginx:1.25
<span class="go">docker.io/library/nginx:1.25

</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr ns <span class="nb">rm </span>alice
<span class="go">alice
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr ns <span class="nb">ls</span>
<span class="go">NAME   LABELS
bob
k8s.io
moby</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="contianerdproxy">3.5. contianerd/proxy</h3>
<div class="paragraph">
<p>The <code>contianerd</code> daemon uses the <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code>, and <code>NO_PROXY</code> environmental variables in its start-up environment to configure HTTP or HTTPS proxy behavior.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a systemd drop-in directory for the containerd service:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">sudo mkdir -p /etc/systemd/system/containerd.service.d</span></code></pre>
</div>
</div>
</li>
<li>
<p>Create a file called <code>20-http-proxy.conf</code> at the above directory that adds the <code>HTTP_PROXY</code> environment variable:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="systemd"><span class="k">[Service]</span>
<span class="nt">Environment</span><span class="p">=</span>"HTTP_PROXY=http://proxy.example.com:80/"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if you are behind an HTTPS proxy server, adds the <code>HTTPS_PROXY</code> environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="systemd"><span class="k">[Service]</span>
<span class="nt">Environment</span><span class="p">=</span>"HTTP_PROXY=http://proxy.example.com:80/"
<span class="nt">Environment</span><span class="p">=</span>"HTTPS_PROXY=https://proxy.example.com:443/"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have internal Docker registries that you need to contact without proxying you can specify them via the <code>NO_PROXY</code> environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="systemd"><span class="k">[Service]</span>
<span class="nt">Environment</span><span class="p">=</span>"HTTP_PROXY=http://proxy.example.com:80/"
<span class="nt">Environment</span><span class="p">=</span>"HTTPS_PROXY=https://proxy.example.com:443/"
<span class="nt">Environment</span><span class="p">=</span>"NO_PROXY=localhost,127.0.0.1,docker-registry.somecorporation.com"</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>NO_PROXY</code> environment variable specifies URLs that should be excluded from proxying (on servers that should be contacted directly).</p>
</div>
<div class="paragraph">
<p>This should be a comma-separated list of hostnames, domain names, or a mixture of both. Asterisks can be used as wildcards, but other clients may not support that. Domain names may be indicated by a leading dot. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">NO_PROXY="*.aventail.com,home.com,.seanet.com"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>says to contact all machines in the ‘aventail.com’ and ‘seanet.com’ domains directly, as well as the machine named ‘home.com’. If <code>NO_PROXY</code> isn’t defined, <code>no_PROXY</code> and <code>no_proxy</code> are also tried, in that order.</p>
</div>
<div class="paragraph">
<p>See also, <a href="https://www.gnu.org/software/emacs/manual/html_node/url/Proxies.html" class="bare">https://www.gnu.org/software/emacs/manual/html_node/url/Proxies.html</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also use the <code>systemctl edit containerd</code> to edit <code>override.conf</code> at <code>/etc/systemd/system/containrd.service.d</code> for the containerd service.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Flush changes:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nb">sudo </span>systemctl daemon-reload</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the configuration has been loaded:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>systemctl status containerd.service
<span class="go">● containerd.service - containerd container runtime
</span><span class="gp">     Loaded: loaded (/lib/systemd/system/containerd.service;</span><span class="w"> </span>enabled<span class="p">;</span> preset: enabled<span class="o">)</span>
<span class="go">    Drop-In: /etc/systemd/system/containerd.service.d
             └─20-http-proxy.conf

</span><span class="gp">$</span><span class="w"> </span>systemctl show <span class="nt">--property</span> Environment containerd.service <span class="nt">--full</span> <span class="nt">--no-pager</span>
<span class="go">Environment=HTTP_PROXY=http://proxy.example.com:80/ HTTPS_PROXY=https://proxy.example.com:443/ NO_PROXY=localhost,127.0.0.1,docker-registry.somecorporation.com</span></code></pre>
</div>
</div>
</li>
<li>
<p>Restart containerd:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nb">sudo </span>systemctl restart containerd</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="crictl">4. crictl</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://kubernetes.io/docs/tasks/debug-application-cluster/crictl/"><code>crictl</code></a> is a command-line interface for CRI-compatible container runtimes. You can use it to inspect and debug container runtimes and applications on a Kubernetes node. crictl and its source are hosted in the <a href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md">cri-tools</a> repository.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl image <span class="nb">ls</span>
<span class="go">WARN[0000] image connect using default endpoints: [unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock]. As the default settings are now deprecated, you should set the endpoint instead.
ERRO[0000] unable to determine image API version: rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing dial unix /var/run/dockershim.sock: connect: connection refused"
IMAGE               TAG                 IMAGE ID            SIZE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To solve the above problem, please specify the <code>runtime-endpoint</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl <span class="nt">--runtime-endpoint</span><span class="o">=</span>unix:///run/containerd/containerd.sock image <span class="nb">ls</span>
<span class="go">IMAGE               TAG                 IMAGE ID            SIZE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="paragraph">
<p>set the the <code>runtime-endpoint</code> in configuration file <code>/etc/crictl.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl config <span class="nt">--set</span> runtime-endpoint<span class="o">=</span>unix:///run/containerd/containerd.sock
<span class="go">
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl image <span class="nb">ls</span>
<span class="go">IMAGE               TAG                 IMAGE ID            SIZE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>see also: <a href="https://kubernetes.io/docs/tasks/debug/debug-cluster/crictl/#general-usage" class="bare">https://kubernetes.io/docs/tasks/debug/debug-cluster/crictl/#general-usage</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><code>crictl image list</code> is <code>ctr -n=k8s.io image list</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> k8s.io i <span class="nb">ls</span>
<span class="go">REF                                                                                               TYPE                                                      DIGEST                                                                  SIZE      PLATFORMS                                                                                                                          LABELS
docker.io/library/busybox:latest                                                                  application/vnd.docker.distribution.manifest.list.v2+json sha256:e7157b6d7ebbe2cce5eaa8cfe8aa4fa82d173999b9f90a9ec42e57323546c353 758.9 KiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/riscv64,linux/s390x io.cri-containerd.image=managed
docker.io/library/busybox@sha256:e7157b6d7ebbe2cce5eaa8cfe8aa4fa82d173999b9f90a9ec42e57323546c353 application/vnd.docker.distribution.manifest.list.v2+json sha256:e7157b6d7ebbe2cce5eaa8cfe8aa4fa82d173999b9f90a9ec42e57323546c353 758.9 KiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/riscv64,linux/s390x io.cri-containerd.image=managed
k8s.gcr.io/pause:3.2                                                                              application/vnd.docker.distribution.manifest.v2+json      sha256:2a7b365f500c323286ac47e9e32af9bd50ee65de7fe2a27355eb5987c8df9ad8 669.7 KiB linux/amd64                                                                                                                        io.cri-containerd.image=managed
sha256:7138284460ffa3bb6ee087344f5b051468b3f8697e2d1427bac1a20c8d168b14                           application/vnd.docker.distribution.manifest.list.v2+json sha256:e7157b6d7ebbe2cce5eaa8cfe8aa4fa82d173999b9f90a9ec42e57323546c353 758.9 KiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/riscv64,linux/s390x io.cri-containerd.image=managed
sha256:80d28bedfe5dec59da9ebf8e6260224ac9008ab5c11dbbe16ee3ba3e4439ac2c                           application/vnd.docker.distribution.manifest.v2+json      sha256:61e45779fc594fcc1062bb9ed2cf5745b19c7ba70f0c93eceae04ffb5e402269 669.7 KiB linux/amd64                                                                                                                        io.cri-containerd.image=managed

</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl image <span class="nb">ls</span>
<span class="go">IMAGE                       TAG                 IMAGE ID            SIZE
docker.io/library/busybox   latest              7138284460ffa       1.46MB
k8s.gcr.io/pause            3.2                 80d28bedfe5de       686kB</span></code></pre>
</div>
</div>
</li>
<li>
<p>create a pod sandbox and run a container</p>
<div class="listingblock">
<div class="title"><em>container-config.json</em></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"busybox"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"image"</span><span class="p">:{</span><span class="w">
    </span><span class="nl">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"busybox"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"top"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"log_path"</span><span class="p">:</span><span class="s2">"busybox.0.log"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"linux"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><em>pod-config.json</em></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nginx-sandbox"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"default"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"attempt"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hdishd83djaidwnduwk28bcsb"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"log_directory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"linux"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl run container-config.json pod-config.json
<span class="go">b08ad7b8517d0e37853f3a7211fbc7ba283a7b34cff5bd0ae108e9d956034a24

</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl pods
<span class="go">POD ID              CREATED             STATE               NAME                NAMESPACE           ATTEMPT             RUNTIME
91ff0a7d5e81a       15 seconds ago      Ready               nginx-sandbox       default             1                   (default)
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl ps
<span class="go">CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID
b08ad7b8517d0       busybox             15 seconds ago      Running             busybox             0                   91ff0a7d5e81a
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl stopp 91ff0a7d5e81a
<span class="go">Stopped sandbox 91ff0a7d5e81a
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl rmp 91ff0a7d5e81a
<span class="go">Removed sandbox 91ff0a7d5e81a</span></code></pre>
</div>
</div>
</li>
<li>
<p>To stop all running containers managed by containerd if using <code>crictl</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl stop <span class="si">$(</span><span class="nb">sudo </span>crictl ps <span class="nt">-q</span><span class="si">)</span>
<span class="go">0509b1b0646b70ed6e78e370730881d1a500d4a335f7198f0150ae16e22ebb48
9d24fcbb60a5627572e29c115f649d0e72c96bc96f8feb185280269f9179cd23
009a342cb16c1cbc20a4ae99679d11ba7263695d1d820a84ec4d4f8baef79e35
</span><span class="c">...</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="docker-and-dockershim">5. docker and dockershim</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>dockershim</em> is a Docker CRI implementation for <a href="https://kubernetes.io/docs/concepts/overview/components/#kubelet">kubelet</a> to interact with <a href="https://docs.docker.com/engine/reference/commandline/dockerd/">dockerd</a> to manage containers.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://d33wubrfki0l68.cloudfront.net/6b4290afef76cad8a084292cd1b5e468e31c9bb3/c26ce/images/blog/2018-05-24-kubernetes-containerd-integration-goes-ga/cri-containerd.png" alt="cri containerd" width="55%" height="55%">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title"><em>dockershim deprecation was announced as a part of the <a href="https://kubernetes.io/blog/2020/12/02/dockershim-faq/">Kubernetes v1.20 release</a>.</em></div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Docker support in the kubelet is now deprecated and will be removed in a future release. The kubelet uses a module called "dockershim" which implements CRI support for Docker and it has seen maintenance issues in the Kubernetes community.</p>
</div>
</blockquote>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Introduce experimental <a href="https://docs.docker.com/storage/containerd/">support for containerd as the content store</a> (replacing the existing storage drivers) of the <a href="https://docs.docker.com/engine/release-notes/24.0/#2400">Docker 24.0</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Developers can still use the Docker platform to build, share, and run containers on Kubernetes!</p>
</div>
<div class="paragraph">
<p>If you’re using Docker, you’re already using containerd.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>dockerd <span class="nt">--help</span> | <span class="nb">grep </span>containerd
<span class="go">      --containerd string                       containerd grpc address
      --containerd-namespace string             Containerd namespace to use (default "moby")
      --containerd-plugins-namespace string     Containerd namespace to use for plugins (default "plugins.moby")
      --cri-containerd                          start containerd with cri

</span><span class="gp">$</span><span class="w"> </span>docker info
<span class="go"> Server Version: 24.0.7
 Storage Driver: overlayfs
  driver-type: io.containerd.snapshotter.v1
 Cgroup Driver: systemd
 Cgroup Version: 2
 Runtimes: io.containerd.runc.v2 runc
 Default Runtime: runc
 containerd version: a1496014c916f9e62104b33d1bb5bd03b0858e59
 runc version: v1.1.11-0-g4bccb38</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The images Docker builds are compliant with OCI (Open Container Initiative), are fully supported on containerd, and will continue to run great on Kubernetes.</p>
</div>
<div class="paragraph">
<p><em>Docker&#8217;s runtime is built upon containerd</em> while providing a great developer experience around it. For production environments that benefit from a minimal container runtime, such as Kubernetes, and may have no need for Docker&#8217;s great developer experience, it&#8217;s reasonable to directly use lightweight runtimes like containerd.</p>
</div>
<div class="paragraph">
<p>containerd uses snapshotters instead of the classic storage drivers for storing image and container data. While the <em>overlay2</em> driver still remains the default driver for Docker Engine, you can opt in to using containerd snapshotters as an <a href="https://docs.docker.com/storage/containerd/">experimental feature</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re using Docker, you&#8217;ll find that the <code>cri</code> plugin was disabled at <code>/etc/containerd/config.toml</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>containerd config dump | <span class="nb">grep</span> <span class="s1">'disabled_plugins'</span>
<span class="go">disabled_plugins = ["cri"]
// OR
</span><span class="gp">$</span><span class="w"> </span><span class="nb">grep </span>cri /etc/containerd/config.toml
<span class="go">disabled_plugins = ["cri"]
// OR
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr plugin <span class="nb">ls</span> | <span class="nb">grep </span>cri</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are two ways to <a href="https://docs.docker.com/engine/daemon/proxy/">configure the Docker daemon to use a proxy server</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuring the daemon through a configuration file or CLI flags</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"proxies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"http-proxy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://proxy.example.com:3128"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"https-proxy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://proxy.example.com:3129"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"no-proxy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*.test.example.com,.example.org,127.0.0.0/8"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Setting environment variables on the system</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ini"><span class="nn">[Service]</span>
<span class="py">Environment</span><span class="p">=</span><span class="s">"HTTP_PROXY=http://proxy.example.com:3128"</span>
<span class="py">Environment</span><span class="p">=</span><span class="s">"HTTPS_PROXY=https://proxy.example.com:3129"</span>
<span class="py">Environment</span><span class="p">=</span><span class="s">"NO_PROXY=localhost,127.0.0.1,docker-registry.example.com,.corp"</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sandbox-image-and-pause-container">6. Sandbox image and pause container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is recommended to keep the <code>sandbox_image</code> of containerd consistent with the <code>pod-infra-container-image</code> (also known as the <strong>pause</strong> container image) of the kubelet.</p>
</div>
<div class="paragraph">
<p>Both images are used to create the pause container, which serves as the "parent container" for all other containers in a Kubernetes pod. Ensuring that these images match helps maintain consistency and avoid potential issues within your Kubernetes environment.</p>
</div>
<div class="paragraph">
<p><em>The pause container holds the network namespace and other shared resources for all containers within a pod.</em></p>
</div>
<div class="paragraph">
<p>Having a consistent pause container image ensures that all components of your Kubernetes cluster use the same image, reducing the likelihood of conflicts and maintaining a unified environment.</p>
</div>
<div class="paragraph">
<p>To make sure both configurations are using the same image, follow these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configure the <code>sandbox_image</code> in containerd&#8217;s configuration file, usually located at <code>/etc/containerd/config.toml</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="toml"><span class="nn">[plugins."io.containerd.grpc.v1.cri"]</span>
  <span class="py">sandbox_image</span> <span class="p">=</span> <span class="s">"registry.k8s.io/pause:3.9"</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl info <span class="nt">-o</span> go-template <span class="nt">--template</span> <span class="s1">'{{.config.sandboxImage}}'</span>
<span class="go">registry.k8s.io/pause:3.9</span></code></pre>
</div>
</div>
</li>
<li>
<p>Configure the <code>pod-infra-container-image</code> in the kubelet&#8217;s configuration file or command-line flags. For example, add the following flag to the kubelet&#8217;s command-line options:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nt">--pod-infra-container-image</span><span class="o">=</span>registry.k8s.io/pause:3.9</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo cat</span> /var/lib/kubelet/kubeadm-flags.env
<span class="go">KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock --pod-infra-container-image=registry.k8s.io/pause:3.9"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or set the <code>pod-infra-container-image</code> in the kubelet&#8217;s configuration file (usually <code>/var/lib/kubelet/config.yaml</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">pod-infra-container-image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">registry.k8s.io/pause:3.9"</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After making these changes, restart the containerd and kubelet services to apply the new configurations.</p>
</div>
<div class="paragraph">
<p>By keeping the <code>sandbox_image</code> and <code>pod-infra-container-image</code> consistent, you can ensure that your Kubernetes cluster operates smoothly and avoids potential issues related to using different pause container images.</p>
</div>
<div class="paragraph">
<p>Here is a pod with multiple containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="c1"># multi.yml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">multi-c</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:1.25</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">qqbuby/net-tools:1.0</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">net-tools</span>
    <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">sleep</span>
    <span class="pi">-</span> <span class="s">3650d</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>kubectl apply <span class="nt">-f</span> multi.yml
<span class="go">pod/multi-c created

// inter-coontainers communication in the same pod using localhost
</span><span class="gp">$</span><span class="w"> </span>kubectl <span class="nb">exec </span>multi-c <span class="nt">-c</span> net-tools <span class="nt">--</span> curl <span class="nt">-iIs</span> localhost
<span class="go">HTTP/1.1 200 OK
Server: nginx/1.25.3
Date: Sat, 03 Feb 2024 07:30:40 GMT
Content-Type: text/html
Content-Length: 615
Last-Modified: Tue, 24 Oct 2023 13:46:47 GMT
Connection: keep-alive
ETag: "6537cac7-267"
Accept-Ranges: bytes


// locate the scheduled node of the pod (e.g node-2)
</span><span class="gp">$</span><span class="w"> </span>kubectl get po multi-c <span class="nt">-owide</span>
<span class="go">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES
</span><span class="gp">multi-c   2/2     Running   0          23m   10.244.1.19   node-2   &lt;none&gt;</span><span class="w">           </span>&lt;none&gt;
<span class="go">
// switch to the node-2, show find the pod using the `crictl`
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl pods <span class="nt">--name</span> multi-c
<span class="go">POD ID              CREATED             STATE               NAME                NAMESPACE           ATTEMPT             RUNTIME
862626e506f99       25 minutes ago      Ready               multi-c             default             0                   (default)

// find the pause container
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> k8s.io c <span class="nb">ls</span> | <span class="nb">grep </span>862626e506f99
<span class="go">862626e506f99825c2afc234ce21a3e561203b2657dd4b5db8c83a858654f7c0    registry.k8s.io/pause:3.9                                          io.containerd.runc.v2

// find the process/task id of the pause container
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> k8s.io t <span class="nb">ls</span> | <span class="nb">grep </span>862626e506f99
<span class="go">862626e506f99825c2afc234ce21a3e561203b2657dd4b5db8c83a858654f7c0    14760    RUNNING

// show the hostname and network of the container
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 14760 <span class="nt">-n</span> <span class="nt">-u</span> <span class="nb">hostname</span>
<span class="go">multi-c
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 14760 <span class="nt">-n</span> <span class="nt">-u</span> ip a
<span class="gp">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
<span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
</span><span class="gp">2: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 1450 qdisc noqueue state UP group default
<span class="go">    link/ether 12:28:a3:72:18:88 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.244.1.19/24 brd 10.244.1.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::1028:a3ff:fe72:1888/64 scope link
       valid_lft forever preferred_lft forever

// find the others containers in the sandbox
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>crictl ps <span class="nt">-p</span> 862626e506f99
<span class="go">CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD
637a1a11e00ed       0fb85279f52dc       44 minutes ago      Running             net-tools           0                   862626e506f99       multi-c
6794ce521b789       b690f5f0a2d53       44 minutes ago      Running             nginx               0                   862626e506f99       multi-c
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ctr <span class="nt">-n</span> k8s.io t <span class="nb">ls</span> | egrep <span class="s1">'637a1a11e00ed|6794ce521b789'</span>
<span class="go">637a1a11e00edc406243154bb8e3636181ae2c4e398d98edb94580cd5a4747e2    15105    RUNNING
6794ce521b789b619885ba91583a5e7a5cf95491fb8719c656cf2f97c01b729a    14949    RUNNING

// show the hostname and network of the containers
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 15105 <span class="nt">-n</span> <span class="nt">-u</span> <span class="nb">hostname</span>
<span class="go">multi-c
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 15105 <span class="nt">-n</span> <span class="nt">-u</span> ip a
<span class="gp">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
<span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
</span><span class="gp">2: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 1450 qdisc noqueue state UP group default
<span class="go">    link/ether 12:28:a3:72:18:88 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.244.1.19/24 brd 10.244.1.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::1028:a3ff:fe72:1888/64 scope link
       valid_lft forever preferred_lft forever
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 14949 <span class="nt">-n</span> <span class="nt">-u</span> <span class="nb">hostname</span>
<span class="go">multi-c
</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>nsenter <span class="nt">-t</span> 14949 <span class="nt">-n</span> <span class="nt">-u</span> ip a
<span class="gp">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
<span class="go">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
</span><span class="gp">2: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 1450 qdisc noqueue state UP group default
<span class="go">    link/ether 12:28:a3:72:18:88 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.244.1.19/24 brd 10.244.1.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::1028:a3ff:fe72:1888/64 scope link
       valid_lft forever preferred_lft forever

// As we see, both of these 3 containers share the same:
//  1. hostname `multi-c`,
//  2. vnet `eth0@if7`
//  3. and address `10.244.1.19/24`.

// switch back the control panel node, and delete the pod
</span><span class="gp">$</span><span class="w"> </span>kubectl delete <span class="nt">-f</span> multi.yml
<span class="go">pod "multi-c" deleted</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references">7. References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://www.docker.com/blog/runc/" class="bare">https://www.docker.com/blog/runc/</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/containerd" class="bare">https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/containerd</a></p>
</li>
<li>
<p><a href="https://www.docker.com/blog/what-is-containerd-runtime/" class="bare">https://www.docker.com/blog/what-is-containerd-runtime/</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/57009928/runc-and-ctr-commands-do-not-show-docker-images-and-containers" class="bare">https://stackoverflow.com/questions/57009928/runc-and-ctr-commands-do-not-show-docker-images-and-containers</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/61738905/how-to-list-docker-containers-using-runc" class="bare">https://stackoverflow.com/questions/61738905/how-to-list-docker-containers-using-runc</a></p>
</li>
<li>
<p><a href="https://github.com/containerd/containerd/blob/main/docs/ops.md" class="bare">https://github.com/containerd/containerd/blob/main/docs/ops.md</a></p>
</li>
<li>
<p><a href="https://github.com/containerd/containerd/blob/main/docs/PLUGINS.md" class="bare">https://github.com/containerd/containerd/blob/main/docs/PLUGINS.md</a></p>
</li>
<li>
<p><a href="https://github.com/containerd/cri/blob/release/1.4/docs/config.md" class="bare">https://github.com/containerd/cri/blob/release/1.4/docs/config.md</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/blog/2018/05/24/kubernetes-containerd-integration-goes-ga/" class="bare">https://kubernetes.io/blog/2018/05/24/kubernetes-containerd-integration-goes-ga/</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/" class="bare">https://kubernetes.io/docs/setup/production-environment/container-runtimes/</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/" class="bare">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/storage/containerd/" class="bare">https://docs.docker.com/storage/containerd/</a></p>
</li>
</ul>
</div>
</div>
</div>
    
<style>
  .utterances {
      max-width: 100%;
  }
</style>
<script src="https://utteranc.es/client.js"
        repo="ousiax/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


  </div>

  <ul class="post-navigation">
    <li>
      
      <a href="/2021/11/23/linux-cgroups-containers/">&laquo; Linux CGroups and Containers</a>
      
    </li>
    <li>
      
      <a href="/2021/11/26/linux-overlayfs-and-container/">Linux OverlayFS and Container &raquo;</a>
      
    </li>
  </ul>
</article>

      </div>
    </div>

    <footer class="site-footer">
  <div class="license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details open>
    <summary>Extral Links</summary>
    <div>
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>


<!-- https://github.com/bryanbraun/anchorjs -->
<script src="/js/anchor.min.js"></script>
<script>
  anchors.add();
  anchors.remove(".site-title");
</script>




  </body>

</html>
